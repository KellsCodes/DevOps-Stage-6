networks:
  app-network:
    driver: bridge

services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    command:
      - "--configFile=/traefik.yml"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./traefik/letsencrypt:/letsencrypt
      - ./traefik/traefik.yml:/traefik.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-network
    labels:
      - "traefik.enable=true"

  # Frontend - Vue.js
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: always
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - auth-api
      - todos-api
      - users-api
    labels:
      - "traefik.enable=true"
      # Frontend ONLY handles root path and non-API routes
      - "traefik.http.routers.frontend.rule=Host(`anyitech.duckdns.org`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.frontend.entrypoints=web,websecure"
      - "traefik.http.routers.frontend.tls.certresolver=le"
      - "traefik.http.routers.frontend.priority=10"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
      # HTTP to HTTPS redirect for frontend
      - "traefik.http.routers.frontend-http.rule=Host(`anyitech.duckdns.org`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.frontend-http.middlewares=https-redirect"
      - "traefik.http.routers.frontend-http.priority=10"

  # Auth API - Go
  auth-api:
    build:
      context: ./auth-api
      dockerfile: Dockerfile
    container_name: auth-api
    restart: always
    env_file:
      - .env
    environment:
      - PORT=8081
    networks:
      - app-network
    depends_on:
      - redis-queue
    labels:
      - "traefik.enable=true"
      # Auth API ONLY handles /api/auth paths
      - "traefik.http.routers.auth.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth.entrypoints=web,websecure"
      - "traefik.http.routers.auth.tls.certresolver=le"
      - "traefik.http.routers.auth.priority=100"
      # Strip /api/auth prefix before sending to backend
      - "traefik.http.middlewares.auth-stripprefix.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-stripprefix"
      - "traefik.http.services.auth.loadbalancer.server.port=8081"
      # HTTP to HTTPS redirect for auth
      - "traefik.http.routers.auth-http.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth-http.entrypoints=web"
      - "traefik.http.routers.auth-http.middlewares=https-redirect"
      - "traefik.http.routers.auth-http.priority=100"

  # Todos API - Node.js
  todos-api:
    build:
      context: ./todos-api
      dockerfile: Dockerfile
    container_name: todos-api
    restart: always
    env_file:
      - .env
    environment:
      - PORT=8082
      - REDIS_URL=redis://redis-queue:6379
    networks:
      - app-network
    depends_on:
      - redis-queue
    labels:
      - "traefik.enable=true"
      # Todos API ONLY handles /api/todos paths
      - "traefik.http.routers.todos.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todos.entrypoints=web,websecure"
      - "traefik.http.routers.todos.tls.certresolver=le"
      - "traefik.http.routers.todos.priority=100"
      # Strip /api/todos prefix before sending to backend
      - "traefik.http.middlewares.todos-stripprefix.stripprefix.prefixes=/api/todos"
      - "traefik.http.routers.todos.middlewares=todos-stripprefix"
      - "traefik.http.services.todos.loadbalancer.server.port=8082"
      # HTTP to HTTPS redirect for todos
      - "traefik.http.routers.todos-http.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todos-http.entrypoints=web"
      - "traefik.http.routers.todos-http.middlewares=https-redirect"
      - "traefik.http.routers.todos-http.priority=100"

  # Users API - Java Spring Boot
  users-api:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    container_name: users-api
    restart: always
    env_file:
      - .env
    environment:
      - SERVER_PORT=8083
      - SPRING_PROFILES_ACTIVE=production
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      # Users API ONLY handles /api/users paths
      - "traefik.http.routers.users.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.users.entrypoints=web,websecure"
      - "traefik.http.routers.users.tls.certresolver=le"
      - "traefik.http.routers.users.priority=100"
      # Strip /api/users prefix before sending to backend
      - "traefik.http.middlewares.users-stripprefix.stripprefix.prefixes=/api/users"
      - "traefik.http.routers.users.middlewares=users-stripprefix"
      - "traefik.http.services.users.loadbalancer.server.port=8083"
      # HTTP to HTTPS redirect for users
      - "traefik.http.routers.users-http.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.users-http.entrypoints=web"
      - "traefik.http.routers.users-http.middlewares=https-redirect"
      - "traefik.http.routers.users-http.priority=100"

  # Log Message Processor - Python
  log-message-processor:
    build:
      context: ./log-message-processor
      dockerfile: Dockerfile
    container_name: log-message-processor
    restart: always
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - redis-queue

  # Redis Queue
  redis-queue:
    image: redis:7-alpine
    container_name: redis-queue
    restart: always
    expose:
      - "6379"
    networks:
      - app-network
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

volumes:
  redis-data:
    driver: local

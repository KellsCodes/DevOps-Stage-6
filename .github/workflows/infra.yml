name: 1-Infrastructure-Terraform

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infra.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      plan_output: ${{ steps.plan.outputs.stdout }}
      has_changes: ${{ steps.detect_changes.outputs.has_changes }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init
        
      - name: Terraform Format Check
        run: |
          cd infra/terraform
          terraform fmt -check || true

      - name: Terraform Validate
        run: |
          cd infra/terraform
          terraform validate

      - name: Terraform Plan
        id: plan
        run: |
          cd infra/terraform
          # terraform plan -no-color -out=tfplan
          terraform plan -var="duckdns_domain=${{ secrets.DUCKDNS_DOMAIN }}" -no-color -out=tfplan
          terraform show -no-color tfplan > plan_output.txt
          cat plan_output.txt
        continue-on-error: true

      - name: Detect Drift
        id: detect_changes
        run: |
          cd infra/terraform
          # Check if plan has any changes
          if terraform show tfplan | grep -q "No changes"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::‚úÖ No infrastructure changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::warning::‚ö†Ô∏è Infrastructure changes detected - drift found!"
          fi

      - name: Save plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/tfplan
          retention-days: 1

      - name: Save plan output
        uses: actions/upload-artifact@v4
        with:
          name: plan_output
          path: infra/terraform/plan_output.txt
          retention-days: 1

      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infra/terraform/plan_output.txt', 'utf8');
            const output = `## Terraform Plan Output
            
            \`\`\`
            ${plan}
            \`\`\``;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  drift-notification:
    name: Drift Detection & Notification
    needs: plan
    runs-on: ubuntu-latest
    if: needs.plan.outputs.has_changes == 'true' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send drift detection email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® Infrastructure Drift Detected - Approval Required"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure drift has been detected!
            
            Workflow: Infrastructure-Terraform
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            Changes detected in:
            - infra/terraform/ OR
            - infra/ansible/
            
            Action Required:
            1. Review the terraform plan at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            2. Approve or reject the infrastructure changes
            3. If approved, the terraform apply will proceed
            
            ‚ö†Ô∏è NO AUTOMATIC APPLY - MANUAL APPROVAL REQUIRED
            
            View full details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Create GitHub Issue for approval
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Infrastructure Drift Detected - Approval Required (Run #${context.runId})`,
              body: `Infrastructure drift has been detected in this commit!
              
              **Workflow**: Infrastructure-Terraform
              **Commit**: ${{ github.sha }}
              **Author**: @${{ github.actor }}
              
              ## Required Actions
              1. Review the terraform plan
              2. Comment with \`/approve\` to apply changes
              3. Or comment with \`/reject\` to skip this run
              
              [View Workflow Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`,
              labels: ['infrastructure', 'drift-detection', 'needs-approval']
            });

  apply:
    name: Terraform Apply
    needs: plan
    runs-on: ubuntu-latest
    if: needs.plan.outputs.has_changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/

      - name: Terraform Init
        run: |
          cd infra/terraform
          terraform init

      - name: Terraform Apply
        run: |
          cd infra/terraform
          terraform apply -no-color tfplan

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Infrastructure Deployment Successful"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure deployment completed successfully!
            
            Workflow: Infrastructure-Terraform
            Status: SUCCESS ‚úÖ
            
            Changes applied:
            - Terraform resources updated
            - Ansible provisioning completed
            - Application deployed
            
            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Infrastructure Deployment Failed"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure deployment FAILED!

            Workflow: Infrastructure-Terraform
            Status: FAILED ‚ùå

            Please review and fix the issues.

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

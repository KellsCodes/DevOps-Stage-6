name: 1-Infrastructure-Terraform

concurrency:
  group: terraform-infra
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infra.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

  # üî• FIXED: Make duckDNS variables available everywhere
  DUCKDNS_DOMAIN: ${{ secrets.DUCKDNS_DOMAIN }}
  DUCKDNS_TOKEN: ${{ secrets.DUCKDNS_TOKEN }}
  SSH_KEY_NAME: ${{ secrets.SSH_KEY_NAME }}
jobs:
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.detect_changes.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Clean old plan files
        run: rm -f infra/terraform/tfplan

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Format Check
        working-directory: infra/terraform
        run: terraform fmt -check || true

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      # ‚úÖ FIX: Safe stale lock cleanup using DynamoDB API
      - name: Auto-remove stale Terraform lock (DynamoDB)
        run: |
          TABLE_NAME="terraform-locks"
          LOCKS=$(aws dynamodb scan --table-name $TABLE_NAME --query "Items[*].LockID.S" --output text)

          if [[ -z "$LOCKS" ]]; then
            echo "No Terraform locks found."
          else
            echo "Found stale locks: $LOCKS"
            for LOCK in $LOCKS; do
              echo "Deleting lock: $LOCK"
              aws dynamodb delete-item \
                --table-name $TABLE_NAME \
                --key "{\"LockID\": {\"S\": \"$LOCK\"}}"
            done
            echo "All stale locks removed."
          fi

      - name: Terraform Plan
        id: plan
        timeout-minutes: 10
        working-directory: infra/terraform
        run: |
          terraform plan \
            -var="duckdns_domain=${DUCKDNS_DOMAIN}" \
            -var="duckdns_token=${DUCKDNS_TOKEN}" \
            -var="ssh_key_name=${SSH_KEY_NAME}" \
            -no-color \
            -out=tfplan

          terraform show -no-color tfplan > plan_output.txt
          cat plan_output.txt

      - name: Detect Drift
        id: detect_changes
        working-directory: infra/terraform
        run: |
          if terraform show tfplan | grep -q "No changes"; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::‚úÖ No infrastructure changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::warning::Infrastructure changes detected - drift found!"
          fi

      - name: Save plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/tfplan

      - name: Save plan output
        uses: actions/upload-artifact@v4
        with:
          name: plan_output
          path: infra/terraform/plan_output.txt

      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('infra/terraform/plan_output.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan Output\n\`\`\`\n${plan}\n\`\`\``
            })

  drift-notification:
    name: Drift Detection & Notification
    needs: plan
    runs-on: ubuntu-latest
    if: needs.plan.outputs.has_changes == 'true' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Send drift detection email
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üö® Infrastructure Drift Detected - Approval Required"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure drift has been detected!

            Workflow: Infrastructure-Terraform
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}

            Action Required:
            1. Review the terraform plan
            2. Approve or reject the changes

      - name: Create GitHub Issue for approval
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Infrastructure Drift Detected (Run #${context.runId})`,
              body: `Infrastructure drift detected. Review Terraform plan and approve if correct.`,
              labels: ['infrastructure', 'drift-detection', 'needs-approval']
            })

  apply:
    name: Terraform Apply
    needs: plan
    runs-on: ubuntu-latest
    if: needs.plan.outputs.has_changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: infra/terraform/

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: infra/terraform
        run: terraform apply -no-color tfplan

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Infrastructure Deployment Successful"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure deployment completed successfully!

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: ${{ secrets.EMAIL_PORT }}
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Infrastructure Deployment Failed"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_FROM }}>"
          body: |
            Infrastructure deployment FAILED!

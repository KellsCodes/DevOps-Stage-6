networks:
  app-network:
    driver: bridge

services:
  # Docker Socket Proxy for Traefik
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-socket-proxy
    environment:
      - CONTAINERS=1
      - NETWORKS=1
      - SERVICES=1
      - TASKS=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-network

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - ./traefik/letsencrypt:/letsencrypt
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
    depends_on:
      - docker-socket-proxy
    environment:
      - TRAEFIK_PROVIDERS_DOCKER_ENDPOINT=unix:///var/run/docker.sock
      - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT=false
    networks:
      - app-network
    labels:
      - "traefik.enable=true"

  # Frontend - Vue.js
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend
    restart: always
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - auth-api
      - todos-api
      - users-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`anyitech.duckdns.org`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.tls.certresolver=le"
      - "traefik.http.routers.frontend.priority=1"
      - "traefik.http.services.frontend.loadbalancer.server.port=8080"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.frontend-http.rule=Host(`anyitech.duckdns.org`)"
      - "traefik.http.routers.frontend-http.entrypoints=web"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.frontend-http.middlewares=https-redirect"

  # Auth API - Go
  auth-api:
    build:
      context: ./auth-api
      dockerfile: Dockerfile
    container_name: auth-api
    restart: always
    env_file:
      - .env
    environment:
      - PORT=8081
    networks:
      - app-network
    depends_on:
      - redis-queue
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth.entrypoints=websecure"
      - "traefik.http.routers.auth.tls=true"
      - "traefik.http.routers.auth.tls.certresolver=le"
      - "traefik.http.routers.auth.priority=100"
      # Strip /api/auth before routing to backend
      - "traefik.http.middlewares.auth-stripprefix.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-stripprefix"
      - "traefik.http.services.auth.loadbalancer.server.port=8081"

  # Todos API - Node.js
  todos-api:
    build:
      context: ./todos-api
      dockerfile: Dockerfile
    container_name: todos-api
    restart: always
    env_file:
      - .env
    environment:
      - PORT=8082
      - REDIS_URL=redis://redis-queue:6379
    networks:
      - app-network
    depends_on:
      - redis-queue
      - auth-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.todos.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/todos`)"
      - "traefik.http.routers.todos.entrypoints=websecure"
      - "traefik.http.routers.todos.tls=true"
      - "traefik.http.routers.todos.tls.certresolver=le"
      - "traefik.http.routers.todos.priority=100"
      # Strip /api/todos before routing to backend
      - "traefik.http.middlewares.todos-stripprefix.stripprefix.prefixes=/api/todos"
      - "traefik.http.routers.todos.middlewares=todos-stripprefix"
      - "traefik.http.services.todos.loadbalancer.server.port=8082"

  # Users API - Java Spring Boot
  users-api:
    build:
      context: ./users-api
      dockerfile: Dockerfile
    container_name: users-api
    restart: always
    env_file:
      - .env
    environment:
      - SERVER_PORT=8083
      - SPRING_PROFILES_ACTIVE=production
    networks:
      - app-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.users.rule=Host(`anyitech.duckdns.org`) && PathPrefix(`/api/users`)"
      - "traefik.http.routers.users.entrypoints=websecure"
      - "traefik.http.routers.users.tls=true"
      - "traefik.http.routers.users.tls.certresolver=le"
      - "traefik.http.routers.users.priority=100"
      # Strip /api/users before routing to backend
      - "traefik.http.middlewares.users-stripprefix.stripprefix.prefixes=/api/users"
      - "traefik.http.routers.users.middlewares=users-stripprefix"
      - "traefik.http.services.users.loadbalancer.server.port=8083"

  # Log Message Processor - Python
  log-message-processor:
    build:
      context: ./log-message-processor
      dockerfile: Dockerfile
    container_name: log-message-processor
    restart: always
    env_file:
      - .env
    networks:
      - app-network
    depends_on:
      - redis-queue

  # Redis Queue
  redis-queue:
    image: redis:7-alpine
    container_name: redis-queue
    restart: always
    expose:
      - "6379"
    networks:
      - app-network
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

volumes:
  redis-data:
    driver: local
